const SAO={_utf8Enc:new TextEncoder,fromBase64(e){return Uint8Array.from(atob(e),e=>e.charCodeAt()).buffer},fromHex:(()=>{let a={};let t=Array.from("0123456789abcdef");for(let e=0;e<256;++e){a[t[e>>>4]+t[e&15]]=e}return t=>{let r=t.length;if(r&1){throw"16進位字串必須有偶數個字元"}let n=new Uint8Array(r>>>1);for(let e=1;e<r;e+=2){n[e>>>1]=a[t.slice(e-1,e+1)]}return n.buffer}})(),toBase64(e){let t=new Uint8Array(e);let r=String.fromCharCode.apply(null,t);return btoa(r)},toHex:(()=>{let a=[];let t=Array.from("0123456789abcdef");for(let e=0;e<256;++e){a.push(t[e>>>4]+t[e&15])}return e=>{let r=new Uint8Array(e);let n="";for(let e=0,t=r.length;e<t;++e){n+=a[r[e]]}return n}})(),hash:async function(e,t,r){t=this._utf8Enc.encode(t);let n=await crypto.subtle.digest(e,t);return r?r(n):n},hash_hmac:async function(e,t,r,n){t=this._utf8Enc.encode(t);r=this._utf8Enc.encode(r);r=await crypto.subtle.importKey("raw",r,{name:"HMAC",hash:{name:e}},false,["sign","verify"]);let a=await crypto.subtle.sign("HMAC",r,t);return n?n(a):a},genKey:async function(e){let t=await crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:e},true,["sign","verify"]);let r=await Promise.all([crypto.subtle.exportKey("pkcs8",t.privateKey),crypto.subtle.exportKey("spki",t.publicKey)]);let n=r.map((e,t)=>{let r=btoa(String.fromCharCode.apply(null,new Uint8Array(e)));let n=t===0?"PRIVATE":"PUBLIC";let a=[`-----BEGIN ${n} KEY-----`];for(let e=0,t=r.length;e<t;e+=64){a.push(r.slice(e,e+64<t?e+64:t))}a.push(`-----END ${n} KEY-----\n`);return a.join("\n")});return{privateKey:n[0],publicKey:n[1]}},_importKey:async function(e,t){t={name:"RSASSA-PKCS1-v1_5",hash:t};let r=e.split("\n");let n=r[0].match(/-----BEGIN ([A-Z]+) KEY-----/)[1];let a=r.reduce((e,t)=>{if(t.length>0&&t[0]!=="-"){e+=t}return e},"");let i=this.fromBase64(a);if(n=="PRIVATE"){return crypto.subtle.importKey("pkcs8",i,t,true,["sign"])}else if(n==="PUBLIC"){return crypto.subtle.importKey("spki",i,t,true,["verify"])}else{return Promise.reject("不支援的 key")}},sign:async function(e,t,r,n){t=await this._importKey(t,r);let a=await crypto.subtle.sign("RSASSA-PKCS1-v1_5",t,this._utf8Enc.encode(e));return n?n(a):a},verify:async function(e,t,r,n,a){r=await this._importKey(r,n);if(a){t=a(t)}let i=await crypto.subtle.verify("RSASSA-PKCS1-v1_5",r,t,this._utf8Enc.encode(e));return i},aes_256_cbc:{_importKey:async function(e){return crypto.subtle.importKey("raw",e,"AES-CBC",false,["encrypt","decrypt"])},gatRandomIV(){return crypto.subtle.getRandomValues(new Uint8Array(16)).buffer},encrypt:async function(e,t,r,n){e=(new TextEncoder).encode(e).buffer;const a={name:"AES-CBC",iv:r};t=await this._importKey(t);let i=await crypto.subtle.encrypt(a,t,e);return n?n(i):i},decrypt:async function(e,t,r,n){if(n){e=n(e)}const a={name:"AES-CBC",iv:r};t=await this._importKey(t);let i=await crypto.subtle.decrypt(a,t,e);return(new TextDecoder).decode(i)}}};